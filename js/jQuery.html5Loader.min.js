/*!
 *
 * Version:     1.5
 * Author:      Gianluca Guarini
 * Contact:     gianluca.guarini@gmail.com
 * Website:     http://www.gianlucaguarini.com/
 * Twitter:     @gianlucaguarini
 *
 * Copyright (c) 2012 Gianluca Guarini
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 **/
(function(a){a.html5Loader=function(e){var p={getFilesToLoadJSON:null,debugMode:true,onBeforeLoad:function(){},onComplete:function(){},onElementLoaded:function(A,B){},onUpdate:function(A){}},d=a.extend(p,e);var k=d.getFilesToLoadJSON,l=d.debugMode,o=d.onBeforeLoad,x=d.onComplete,h=d.onElementLoaded,u=d.onUpdate;var r=a(window),v=a("body"),i=0,m=0,w=[],z={};var j=function(A){if(l&&console){console.log(A)}};z.video=function(){var B=document.createElement("video"),A=false;try{if(A=!!B.canPlayType){A=new Boolean(A);A.ogg=B.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,"");A.h264=B.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,"");A.webm=B.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,"")}}catch(C){}return A}();z.audio=function(){var B=document.createElement("audio"),A=false;try{if(A=!!B.canPlayType){A=new Boolean(A);A.ogg=B.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"");A.mp3=B.canPlayType("audio/mpeg;").replace(/^no$/,"");A.wav=B.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"");A.m4a=(B.canPlayType("audio/x-m4a;")||B.canPlayType("audio/aac;")).replace(/^no$/,"")}}catch(C){}return A}();var f=function(B){var C=B.type.toLowerCase(),A=B.sources;a.each(A,function(D){if(z[C][D]){B=B.sources[D];B.type=C.toUpperCase();return false}});if(B.source){return B}else{return false}};var q=function(){var A=0;j("_bytesTotal = "+m);j("_bytesLoaded = "+i);A=Math.round((i/m)*100);j("Percentage: "+A+"%");u(A);if(!w.length){x()}};var b=function(A,C){var B=C;if(B.type==="VIDEO"||B.type==="AUDIO"){B=f(B)}if(B){m+=B.size;w.push(B)}};var g=function(A){j("json loaded");a(A.files).each(b)};var c=function(B){var D=new a.Deferred(),A=B.size,C=a("<img>");a(C).on("load",function(E){j("File Loaded:"+B.source);i+=A;h(B,C[0]);C=null;w.splice(0,1);q();D.resolve()});C.attr("src",B.source);return D.promise()};var y=function(B){var D=new a.Deferred(),A=B.size,C=B.type==="VIDEO"?a("<video></video>"):a("<audio></audio>");C.on("loadedmetadata",function(){C.on("progress",function(){var E=0;j("loading in progress file:"+B.source);if(this.buffered.length>0){E=(A/this.duration)*this.buffered.end(0);A-=E;i+=E;q()}})});C.on("canplaythrough",function(){j("File Loaded:"+B.source);i+=A;h(B,C[0]);w.splice(0,1);C.off();C=null;q();D.resolve()});C.attr({preload:"auto",src:B.source});return D.promise()};var n=function(B){var C=new a.Deferred(),A=B.size;a.getScript(B.source,function(D){j("File Loaded:"+B.source);i+=A;h(B,D);w.splice(0,1);q();C.resolve()});return C.promise()};var s=function(A){var B=new a.Deferred();a.ajax({url:A.source,dataType:"text",success:function(C){j("File Loaded:"+A.source);h(A,C);i+=A.size;w.splice(0,1);q();B.resolve(C)}});return B.promise()};var t=function(){if(w.length){j("preloading files");var A=w[0];j("file to preload:"+A.source);switch(A.type){case"IMAGE":c(A).then(t);break;case"VIDEO":case"AUDIO":y(A).then(t);break;case"SCRIPT":n(A).then(t);break;case"TEXT":s(A).then(t);break;default:return false}}else{return false}};this.init=function(){j("plugin initialized");var B=new a.Deferred(),A=B.promise();o();a.getJSON(k,B.resolve);B.pipe(a.proxy(g,this));A.then(a.proxy(q,this));A.then(a.proxy(t,this))};this.init();return this}})(jQuery);
