/*!
 *
 * Version:     1.4
 * Author:      Gianluca Guarini
 * Contact:     gianluca.guarini@gmail.com
 * Website:     http://www.gianlucaguarini.com/
 * Twitter:     @gianlucaguarini
 *
 * Copyright (c) 2011 Gianluca Guarini
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 **/
(function(a){a.fn.extend({html5Loader:function(v){var A=this;var z={preloaderType:"circular",currPercentage:0,getFilesToLoadJSON:null,positionX:A.width()/2,positionY:A.height()/2,lineWidth:5,color:"#ffffff",font:"normal 11px Arial",fullScreen:true,pathToFallbackGif:"../preloaderFallback.gif",radius:40,glowColor:null,debugMode:true,onComplete:function(){},onElementLoaded:function(T,U){},onUpdate:function(T){}};var v=a.extend(z,v);var p=v.preloaderType,Q=v.currPercentage,y=v.positionX,w=v.positionY,r=v.lineWidth,x=v.color,L=v.font,E=v.getFilesToLoadJSON,C=v.pathToFallbackGif,H=v.radius,u=v.fullScreen,o=v.glowColor,R=v.debugMode,F=v.onComplete,q=v.onElementLoaded,e=v.onUpdate;var j=null,h=Math.PI,k={startAngle:1.5*h,endAngle:0},K=a(window),N=a(A).attr("id")==undefined?a(A).attr("class"):a(A).attr("id"),c=0,t=0,G=0,d=false,i=[],l=[],S=[],M=[],P=[],D=[],J=Modernizr.video.h264,b=Modernizr.video.ogg,n=Modernizr.video.webm,O=Modernizr.audio.mp3,f=Modernizr.audio.ogg,I=[],m=0,B=[],s=[],g=this;g.setFullscreen=function(){g.logger("Setting Full screen");A.css({position:"fixed",height:K.height(),width:K.width(),"z-index":98,top:0});y=A.width()/2;w=A.height()/2;a(A).html('<canvas id="html5Canvas'+N+'" width="'+a(A).width()+'px "height="'+a(A).height()+'px"></canvas>');j=document.getElementById("html5Canvas"+N);a(j).css({position:"fixed",top:(K.height()/2)-(a(j).height()/2),left:(K.width()/2)-(a(j).width()/2),"z-index":99});K.bind("resize.CenterCanvas",function(){a(j).css({top:(K.height()/2)-(a(j).height()/2),left:(K.width()/2)-(a(j).width()/2)});A.css({position:"fixed",height:K.height(),width:K.width(),"z-index":98})})};g.logger=function(T){if(R){console.log(T)}};g.fillFilesArray=function(U,V,T,W){t+=V;g.logger("Getting file:"+T+" Size: "+V);i.push(U);l.push(V);S.push(T);M.push(W)};g.onElementLoaded=function(T,U){if(typeof q==="function"){q(T,U)}};g.startLoadElements=function(){a(i).each(function(V,X){var Y="?"+Math.random();S[V]+=Y;if(l[V]>0){if(M[V]=="IMAGE"){var aa=new Image();aa.src=S[V];a(aa).on("load",function(){g.onElementLoaded(S[V],X);G+=l[V];g.updatePercentage(G);g.logger("File Loaded:"+S[V]);aa=null});g.logger("Loading file:"+S[V])}if(M[V]=="SCRIPT"){a.getScript(S[V],function(){g.onElementLoaded(S[V],X);G+=l[V];g.updatePercentage(G);g.logger("File Loaded:"+S[V])});g.logger("Loading file:"+S[V])}if(M[V]=="VIDEO"||M[V]=="AUDIO"){var W=m;I[W]=document.getElementById(i[V]);I[W].src=S[V];var U=l[V],T=0,Z=0;I[W].addEventListener("progress",B[W]=function(ab){if(typeof I[W].buffered!=="undefined"){if(I[W].buffered.length>0){T=(U/I[W].duration)*I[W].buffered.end(0)}Z=parseInt(T-Z);l[V]-=Z;G+=Z;g.updatePercentage(G);Z=T;g.logger("File Loading in progress:"+S[V])}},true);I[W].addEventListener("canplaythrough",s[W]=function(ab){I[W].removeEventListener("progress",B[W],true);I[W].removeEventListener("canplaythrough",s[W],true);G+=l[V];g.onElementLoaded(S[V],I[W]);g.updatePercentage(G);g.logger("File Loaded:"+S[V])},true);m++;g.logger("Loading file:"+S[V])}}})};g.updatePercentage=function(T){g.logger("_bytesLoaded: "+T+" _bytesTotal"+t);if(T!==t){Q=Math.floor((T/t)*100)}if(!Q){Q=0}else{if(T===t){Q=100}}g.logger("Percentage: "+Q+"%");if(typeof e==="function"){e(Q)}if(v.preloaderType==="line"&&Modernizr.canvas){g.drawLinePreloader(Q)}if((v.preloaderType==="circular"&&Modernizr.canvas)){g.draw_CircularPreloader(Q)}if((v.preloaderType==="big-counter"&&Modernizr.canvas)){g.draw_BigCounterPreloader(Q)}};g.onComplete=function(){if(c>=100){A.delay(1000).fadeOut(function(){K.unbind("CenterCanvas");a(this).remove();if(typeof F==="function"){F()}})}};g.drawLinePreloader=function(T){g.logger("Drawing line");a({perc:c}).animate({perc:T},{duration:1000,step:function(){if(this.perc<101){c=T;var X=A.innerWidth(),U=A.innerHeight();var W=j.getContext("2d");var V=(X/100)*this.perc;W.clearRect(0,0,X,U);W.restore();W.beginPath();W.font=L;W.fillStyle=x;W.fillText((this.perc|0)+"%",y-8,w-15);W.lineWidth=r;W.strokeStyle=x;if(o!=null){W.shadowOffsetX=0;W.shadowOffsetY=0;W.shadowBlur=10;W.shadowColor=o}W.moveTo(y-(X/2),w);W.lineTo(V,w);W.stroke();W.save()}},complete:g.onComplete})};g.draw_CircularPreloader=function(T){g.logger("Drawing circle");g.logger(T);a({perc:c}).animate({perc:T},{queque:false,duration:1000,step:function(){if(this.perc<101){c=T;var V=j.getContext("2d");var U=(2/100)*this.perc;k.endAngle=(U*h)+k.startAngle;V.clearRect(0,0,A.width(),A.height());V.restore();V.beginPath();V.font=L;V.fillStyle=x;V.fillText((this.perc|0)+"%",y-10,w+3);V.lineWidth=r;V.strokeStyle=x;if(o!=null){V.shadowOffsetX=0;V.shadowOffsetY=0;V.shadowBlur=10;V.shadowColor=o}V.arc(y,w,H,k.startAngle,k.endAngle,false);V.stroke();V.save()}},complete:g.onComplete})};g.draw_BigCounterPreloader=function(T){g.logger("Drawing circle");g.logger(T);a({perc:c}).animate({perc:T},{queque:false,duration:1000,step:function(){if(this.perc<101){c=T;var X=A.innerWidth(),U=A.innerHeight();var W=j.getContext("2d");W.save();var V=(X/100)*this.perc;W.clearRect(0,0,X,U);W.restore();W.beginPath();W.font=L;W.fillStyle=x;W.fillText((this.perc|0)+"%",y-8,w-15);W.lineWidth=U;W.strokeStyle=x;if(o!=null){W.shadowOffsetX=0;W.shadowOffsetY=0;W.shadowBlur=10;W.shadowColor=o}W.moveTo(y-(X/2),w);W.lineTo(V,w);W.globalCompositeOperation="xor";W.stroke();W.restore()}},complete:g.onComplete})};g.init=function(T){g.logger("Start application!");if(!E&&Q===0){alert("plese insert a path to the json file")}if(E&&(Modernizr.audio&&Modernizr.video)){a.getJSON(E,function(X){var W=X.files;a.each(X.files,function(af,Y){var ac=null,ab=null,ah=null,Z=null;ac=Y.type;var ae=String((new Date()).getTime()).replace(/\D/gi,"");switch(ac){case"IMAGE":ab=Y.source,ah=Y.size,Z=a('img[src="'+ab+'"]');a(Z).attr("src",ab+"?"+ae);break;case"VIDEO":var aa=Y.videoId;Z=aa;a("#"+aa).attr("preload","auto");if(J){ab=Y.mp4.source;ah=Y.mp4.size}if(b){ab=Y.ogg.source;ah=Y.ogg.size}if(n){ab=Y.webm.source;ah=Y.webm.size}break;case"AUDIO":var ad=Y.audioId;Z=ad;a("#"+ad).attr("preload","auto");if(Modernizr.audio.mp3&&Modernizr.audio.mp3){ab=Y.mp3.source;ah=Y.mp3.size}if(Modernizr.audio.ogg&&Modernizr.audio.ogg){ab=Y.ogg.source;ah=Y.ogg.size}else{ab="we can't detect preferred browser audio format";ah=0}break;case"SCRIPT":ab=Y.source;ah=Y.size;Z=ab;break;default:throw"something went wrong loading the JSON file!";break}g.fillFilesArray(Z,ah,ab,ac);var ag=(af==(W.length-1));if(ag){g.startLoadElements()}})})}if(Modernizr.canvas){if(u){g.setFullscreen()}else{a(A).html('<canvas id="html5Canvas'+N+'" width="'+a(A).width()+'px "height="'+a(A).height()+'px"></canvas>');j=document.getElementById("html5Canvas"+N)}if(E){g.updatePercentage(0)}if(T.preloaderType=="line"){g.drawLinePreloader(Q)}if(T.preloaderType=="circular"){g.draw_CircularPreloader(Q)}if(T.preloaderType=="big"){g.draw_BigCounterPreloader(Q)}}else{g.logger("Fallback");var U;if(u){U=A.append('<img src="'+C+'" alt="loading page..." /> ');var V=A.find("img").attr("src",C);V.css({position:"fixed",top:(K.height()/2)-(V.height()/2),left:(K.width()/2)-(V.width()/2),"z-index":99});A.css({position:"fixed",height:K.height(),width:K.width(),"z-index":98});K.bind("resize.CenterCanvas",function(){var W=A.find("img").attr("src",C);W.css({top:(K.height()/2)-(W.height()/2),left:(K.width()/2)-(W.width()/2)});A.css({position:"fixed",height:K.height(),width:K.width()})})}else{U=A.append('<img src="'+C+'" alt="loading page..." /> ');U.css({"float":"left",marginLeft:y,marginTop:w})}K.ready(function(){U.delay(1000).fadeOut(function(){a(this).remove()})})}};return g.init(v)}})})(jQuery);
